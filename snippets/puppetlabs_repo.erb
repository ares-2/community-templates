<%#
kind: snippet
name: puppetlabs_repo
-%>
<%
http_proxy   = host_param('http-proxy') ? " --httpproxy #{host_param('http-proxy')}" : nil
http_port    = host_param('http-proxy-port') ? " --httpport #{host_param('http-proxy-port')}" : nil
proxy_uri    = host_param('http-proxy') ? "http://#{host_param('http-proxy')}:#{host_param('http-proxy-port')}" : nil
proxy_string = proxy_uri ? " -e https_proxy=#{proxy_uri}/" : ''
os_family = @host.operatingsystem.family
os_major  = @host.operatingsystem.major.to_i
os_name   = @host.operatingsystem.name

if os_family == 'Redhat'
  repo_host = 'yum.puppetlabs.com'
  if os_name == 'Fedora'
    repo_os = 'fedora'
  else
    repo_os = 'el'
  end
elsif os_family == 'Debian'
  repo_host = 'apt.puppetlabs.com'
  repo_os = @host.operatingsystem.release_name
end

if host_param_true?('enable-puppetlabs-repo')
  repo_name = 'puppetlabs-release'
elsif host_param_true?('enable-puppetlabs-pc1-repo')
  repo_name = 'puppetlabs-release-pc1'
end
-%>
<% if repo_name -%>
<% if os_family == 'Redhat' -%>
rpm -Uvh<%= http_proxy %><%= http_port %> https://<%= repo_host %>/<%= repo_name %>-<%= repo_os %>-<%= os_major %>.noarch.rpm
<% elsif os_family == 'Debian' -%>
apt-get update
apt-get -y install ca-certificates
wget -O /tmp/<%= repo_name %>-<%= repo_os %>.deb<%= proxy_string %> https://<%= repo_host %>/<%= repo_name %>-<%= repo_os %>.deb
dpkg -i /tmp/<%= repo_name %>-<%= repo_os %>.deb
<% end -%>
<% end -%>
